<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Crime City 3D - Full Version</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: Arial, sans-serif; }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            pointer-events: none;
        }
        .key {
            display: inline-block;
            border: 1px solid #fff;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px;
        }
    </style>
</head>
<body>

    <div id="ui">
        <h2>Crime City 3D</h2>
        <p>שליטה במכונית:</p>
        <div><span class="key">W</span> / <span class="key">↑</span> - קדימה</div>
        <div><span class="key">S</span> / <span class="key">↓</span> - אחורה</div>
        <div><span class="key">A</span> / <span class="key">←</span> - פנייה שמאלה</div>
        <div><span class="key">D</span> / <span class="key">→</span> - פנייה ימינה</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- הגדרות עולם ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // שמיים
        scene.fog = new THREE.Fog(0x87ceeb, 50, 150); // ערפל ליצירת עומק

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; // הפעלת צללים
        document.body.appendChild(renderer.domElement);

        // --- תאורה ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const sunLight = new THREE.DirectionalLight(0xffffff, 1);
        sunLight.position.set(50, 100, 50);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // --- קרקע ---
        const groundGeom = new THREE.PlaneGeometry(1000, 1000);
        const groundMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
        const ground = new THREE.Mesh(groundGeom, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // --- בניית עיר אקראית ---
        function createCity() {
            const buildingGeom = new THREE.BoxGeometry(1, 1, 1);
            for (let i = 0; i < 100; i++) {
                const h = 5 + Math.random() * 15;
                const w = 5 + Math.random() * 5;
                const material = new THREE.MeshPhongMaterial({ 
                    color: new THREE.Color(`hsl(${Math.random() * 360}, 20%, 40%)`) 
                });
                const b = new THREE.Mesh(buildingGeom, material);
                
                b.position.x = (Math.random() - 0.5) * 300;
                b.position.z = (Math.random() - 0.5) * 300;
                // מניעת בנייה על מרכז המפה שבו המכונית מתחילה
                if (Math.abs(b.position.x) < 15 && Math.abs(b.position.z) < 15) continue;
                
                b.scale.set(w, h, w);
                b.position.y = h / 2;
                b.castShadow = true;
                b.receiveShadow = true;
                scene.add(b);
            }
        }
        createCity();

        // --- מודל המכונית ---
        function createCar() {
            const group = new THREE.Group();
            
            // גוף
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(2.2, 1, 4.5),
                new THREE.MeshPhongMaterial({ color: 0x990000 })
            );
            body.position.y = 0.8;
            body.castShadow = true;
            group.add(body);

            // גג
            const cabin = new THREE.Mesh(
                new THREE.BoxGeometry(1.8, 0.8, 2.2),
                new THREE.MeshPhongMaterial({ color: 0xffffff })
            );
            cabin.position.y = 1.6;
            cabin.position.z = -0.3;
            cabin.castShadow = true;
            group.add(cabin);

            // גלגלים
            const wheelGeom = new THREE.CylinderGeometry(0.5, 0.5, 0.4, 16);
            const wheelMat = new THREE.MeshPhongMaterial({ color: 0x111111 });
            const wheelPositions = [
                [-1.2, 0.5, 1.5], [1.2, 0.5, 1.5],
                [-1.2, 0.5, -1.5], [1.2, 0.5, -1.5]
            ];
            wheelPositions.forEach(pos => {
                const wheel = new THREE.Mesh(wheelGeom, wheelMat);
                wheel.position.set(pos[0], pos[1], pos[2]);
                wheel.rotation.z = Math.PI / 2;
                group.add(wheel);
            });

            return group;
        }

        const playerCar = createCar();
        scene.add(playerCar);

        // --- בקרת תנועה ---
        const keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        let speed = 0;
        let angle = 0;
        const maxSpeed = 0.8;
        const acceleration = 0.02;
        const friction = 0.95;

        // --- לולאת המשחק ---
        function animate() {
            requestAnimationFrame(animate);

            // חישוב מהירות
            if (keys['ArrowUp'] || keys['KeyW']) speed += acceleration;
            if (keys['ArrowDown'] || keys['KeyS']) speed -= acceleration;

            // חיכוך ועצירה
            speed *= friction;
            if (Math.abs(speed) < 0.001) speed = 0;
            if (speed > maxSpeed) speed = maxSpeed;
            if (speed < -maxSpeed/2) speed = -maxSpeed/2;

            // פנייה
            if (speed !== 0) {
                const turnSpeed = 0.04 * (speed / maxSpeed);
                if (keys['ArrowLeft'] || keys['KeyA']) angle += turnSpeed;
                if (keys['ArrowRight'] || keys['KeyD']) angle -= turnSpeed;
            }

            // עדכון מיקום המכונית
            playerCar.position.x += Math.sin(angle) * speed;
            playerCar.position.z += Math.cos(angle) * speed;
            playerCar.rotation.y = angle;

            // עדכון מצלמה עוקבת
            const camOffset = new THREE.Vector3(0, 8, -15);
            camOffset.applyQuaternion(playerCar.quaternion);
            camera.position.lerp(playerCar.position.clone().add(camOffset), 0.1);
            camera.lookAt(playerCar.position);

            renderer.render(scene, camera);
        }

        // התאמה למסך
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
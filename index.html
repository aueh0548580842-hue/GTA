<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×¨×‘×™ ×¢×§×™×‘× Pro - ×¦××ª×™× ×•×¨××–×•×¨×™×</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #ui {
            position: absolute; top: 10px; right: 10px;
            color: #fff; background: rgba(0,0,0,0.85);
            padding: 15px; border-right: 5px solid #ffcc00; border-radius: 8px;
            pointer-events: none; z-index: 100; font-weight: bold; font-size: 16px; text-align: right;
        }
        #controls {
            position: absolute; bottom: 30px; left: 30px;
            display: grid; grid-template-columns: repeat(3, 80px); grid-gap: 10px; z-index: 100;
        }
        .btn {
            width: 80px; height: 80px; background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 35px; user-select: none;
        }
        .btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        #alert {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff0000; font-size: 40px; font-weight: bold; display: none; z-index: 1000;
            text-shadow: 2px 2px #000; pointer-events: none;
        }
        @media (min-width: 1024px) { #controls { display: none; } }
    </style>
</head>
<body>

    <div id="alert">×¢×‘×¨×ª ×‘××“×•×! ğŸš¦</div>
    <div id="ui">
        <strong>×¨×—×•×‘ ×¨×‘×™ ×¢×§×™×‘× - ×¡×™××•×œ×¦×™×™×ª ×¦××ª×™×</strong><br>
        ×©×™××• ×œ×‘ ×œ×¨××–×•×¨×™× ×‘×¦××ª×™×!
    </div>

    <div id="controls">
        <div id="up" class="btn" style="grid-column: 2;">â†‘</div>
        <div id="left" class="btn" style="grid-column: 1; grid-row: 2;">â†</div>
        <div id="down" class="btn" style="grid-column: 2; grid-row: 2;">â†“</div>
        <div id="right" class="btn" style="grid-column: 3; grid-row: 2;">â†’</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>

    <script>
        // --- ××ª×—×•×œ ×¡×¦× ×” ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        scene.fog = new THREE.Fog(0x000000, 10, 400);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const ambLight = new THREE.AmbientLight(0x202030, 0.5);
        scene.add(ambLight);

        // --- ××©×ª× ×™ ×¨××–×•×¨×™× ---
        let trafficState = "GREEN"; // GREEN, YELLOW, RED
        const trafficLights = [];
        const INTERSECTION_Z = [-600, -300, 0, 300, 600];

        // --- ×‘× ×™×™×ª ×”×¢×•×œ× ---
        const road = new THREE.Mesh(new THREE.PlaneGeometry(55, 2000), new THREE.MeshStandardMaterial({ color: 0x080808, roughness: 0.1 }));
        road.rotation.x = -Math.PI / 2; scene.add(road);

        function createTrafficLight(x, z) {
            const group = new THREE.Group();
            const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 10), new THREE.MeshStandardMaterial({ color: 0x111111 }));
            pole.position.y = 5; group.add(pole);

            const box = new THREE.Mesh(new THREE.BoxGeometry(1.5, 4, 1.5), new THREE.MeshStandardMaterial({ color: 0x050505 }));
            box.position.y = 9; group.add(box);

            const createLamp = (color, y) => {
                const l = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({ color: 0x222222 }));
                l.position.set(0, y, 0.8);
                group.add(l);
                return l;
            };

            const lamps = {
                red: createLamp(0xff0000, 10),
                yellow: createLamp(0xffaa00, 9),
                green: createLamp(0x00ff00, 8)
            };

            group.position.set(x, 0, z);
            scene.add(group);
            trafficLights.push(lamps);
        }

        INTERSECTION_Z.forEach(z => {
            createTrafficLight(30, z);
            createTrafficLight(-30, z);
        });

        // --- ×¨×›×‘ ×©×—×§×Ÿ ---
        const player = new THREE.Group();
        const carBody = new THREE.Mesh(new THREE.BoxGeometry(2.2, 1.4, 4.8), new THREE.MeshStandardMaterial({ color: 0x0044ff }));
        carBody.position.y = 1; player.add(carBody);
        player.userData = { speed: 0, angle: 0 };
        scene.add(player);

        // --- ×œ×•×’×™×§×ª ×¨××–×•×¨×™× ---
        function updateTrafficSystem() {
            const time = Date.now() % 15000; // ××—×–×•×¨ ×©×œ 15 ×©× ×™×•×ª
            if (time < 7000) trafficState = "GREEN";
            else if (time < 10000) trafficState = "YELLOW";
            else trafficState = "RED";

            trafficLights.forEach(l => {
                l.red.material.color.set(trafficState === "RED" ? 0xff0000 : 0x222222);
                l.yellow.material.color.set(trafficState === "YELLOW" ? 0xffaa00 : 0x222222);
                l.green.material.color.set(trafficState === "GREEN" ? 0x00ff00 : 0x222222);
            });
        }

        // --- ×‘×§×¨×™× ---
        const keys = {};
        window.onkeydown = e => keys[e.code] = true;
        window.onkeyup = e => keys[e.code] = false;

        function animate() {
            requestAnimationFrame(animate);
            updateTrafficSystem();

            // ×ª× ×•×¢×”
            if(keys['ArrowUp'] || keys['KeyW']) player.userData.speed += 0.02;
            if(keys['ArrowDown'] || keys['KeyS']) player.userData.speed -= 0.02;
            player.userData.speed *= 0.96;

            if(Math.abs(player.userData.speed) > 0.01) {
                if(keys['ArrowLeft'] || keys['KeyA']) player.userData.angle += 0.03;
                if(keys['ArrowRight'] || keys['KeyD']) player.userData.angle -= 0.03;
            }

            player.position.x += Math.sin(player.userData.angle) * player.userData.speed;
            player.position.z += Math.cos(player.userData.angle) * player.userData.speed;
            player.rotation.y = player.userData.angle;

            // ×‘×“×™×§×ª ××¢×‘×¨ ×‘××“×•× (×¤×©×•×˜×” ×œ×¤×™ ××™×§×•× Z)
            let isViolating = false;
            if (trafficState === "RED") {
                INTERSECTION_Z.forEach(z => {
                    if (Math.abs(player.position.z - z) < 10) isViolating = true;
                });
            }
            document.getElementById('alert').style.display = isViolating ? 'block' : 'none';

            // ××¦×œ××”
            camera.position.x = player.position.x - Math.sin(player.userData.angle) * 15;
            camera.position.z = player.position.z - Math.cos(player.userData.angle) * 15;
            camera.position.y = 7;
            camera.lookAt(player.position.x, 2, player.position.z);

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
